#include "vfd_8d14s.h"
#include "pt6311.h"

static const uint16_t VFDCO_8D14S_ASCII[] = {
  0b0000000000000000, // 32: white space
  0b0000001000100000, // 33: !
  0b0000000000000000, // 34: " (not representable)
  0b0001000111010010, // 35: ugly #
  0b0101000111100011, // 36: $
  0b0100010100101000, // 37: ugly %
  0b0101101010001101, // 38: ugly &
  0b0000000000000000, // 39: ' (not representable)
  0b0001001000100001, // 40: (
  0b0001000100010001, // 41: )
  0b0100110000001110, // 42: *
  0b0100000011000010, // 43: +
  0b0000010000000000, // 44: ,
  0b0100000011000000, // 45: -
  0b0000100000000000, // 46: .
  0b0100010000001000, // 47: /

  0b0001001100110001, // 48: 0
  0b0000000100010000, // 49: 1
  0b0101001011010001, // 50: 2
  0b0101000111010001, // 51: 3
  0b0100000111110000, // 52: 4
  0b0101000111100001, // 53: 5
  0b0101001111100001, // 54: 6
  0b0000000100010001, // 55: 7
  0b0101001111110001, // 56: 8
  0b0101000111110001, // 57: 9

  0b0000000000000010, // 58: :
  0b0000000000000010, // 59: ; (not representable)
  0b0100100000001000, // 60: <
  0b0101000011000000, // 61: =
  0b0100010000000100, // 62: >
  0b0101010000101001, // 63: ugly ?
  0b0101111111111111, // 64: ugly @

  0b0100001111110001, // 65: A
  0b0101001111100000, // 66: B
  0b0001001000100001, // 67: C
  0b0101001111010000, // 68: D
  0b0101001011100001, // 69: E
  0b0100001011100001, // 70: F
  0b0001001101100001, // 71: G
  0b0100001111110000, // 72: H
  0b0101000000000011, // 73: I
  0b0001001100010001, // 74: J
  0b0100101010101000, // 75: K
  0b0001001000100000, // 76: L
  0b0100001100111100, // 77: M
  0b0100001111000000, // 78: N
  0b0001001100110001, // 79: O
  0b0100001011110001, // 80: P
  0b0100000111110001, // 81: Q
  0b0100001011000000, // 82: R
  0b0101000111100001, // 83: S
  0b0100000000000011, // 84: T
  0b0001001100110000, // 85: U
  0b0100011000101000, // 86: V
  0b0100111100110000, // 87: W
  0b0100110000001100, // 88: X
  0b0101000111110000, // 89: Y
  0b0101010000001001, // 90: Z

  0b0001001000100001, // 91: [
  0b0100100000000100, // 92: backslash
  0b0001000100010001, // 93: ]
  0b0000000000110001, // 94: ^
  0b0001000000000000, // 95: _
  0b0000000000000100, // 96: `

  0b0100001111110001, // 97: a
  0b0101001111100000, // 98: b
  0b0001001000100001, // 99: c
  0b0101001111010000, // 100: d
  0b0101001011100001, // 101: e
  0b0100001011100001, // 102: f
  0b0101000101010101, // 103: g // 0b0001001101100001, // 103: g (cap)
  0b0100001111110000, // 104: h
  0b0101000000000011, // 105: i
  0b0001001100010001, // 106: j
  0b0100101010101000, // 107: k
  0b0001001000100000, // 108: l
  0b0100001100111100, // 109: m
  0b0100001111000000, // 110: n
  0b0001001100110001, // 111: o
  0b0100001011110001, // 112: p
  0b0100000111110001, // 113: q
  0b0100001011000000, // 114: r
  0b0101000111100001, // 115: s
  0b0100000000000011, // 116: t
  0b0001001100110000, // 117: u
  0b0100011000101000, // 118: v
  0b0100111100110000, // 119: w
  0b0100110000001100, // 120: x
  0b0101000111110000, // 121: y
  0b0101010000001001, // 122: z

  0b0001010010000101, // 123: {
  0b0100000000000010, // 124: |
  0b0001100001001001, // 125: }
  0b0100000011000000, // 126: ~ (not representable)
  0b0000000000000000  // 127: white space
};

void vfdco_8d14s_init() {
  vfdco_pt6311_init(8);
}

void vfdco_8d14s_write_char(uint8_t digit_position, char character) {
  uint16_t _raw = (character >= 32 && character <= 127) ? VFDCO_8D14S_ASCII[character - 32] : 0;
  vfdco_pt6311_set_data(8 - digit_position - 1, _raw);
}

void vfdco_8d14s_write_char_with_overlay(uint8_t digit_position, char character, uint16_t overlay){
  uint16_t _raw = (character >= 32 && character <= 127) ? VFDCO_8D14S_ASCII[character - 32] : 0;
  vfdco_pt6311_set_data(8 - digit_position - 1, _raw | overlay);
}

void vfdco_8d14s_write_string(char *text) {
  // No null check is performed, assume text larger than length of 8
  for(uint8_t i = 0; i < 8; ++i) {
    vfdco_8d14s_write_char(i, text[i]);
  }
}

void vfdco_8d14s_write_string_with_overlay(char *text, uint8_t overlay){
  // No null check is performed, assume overlay_arr, text larger than length of 8
  uint16_t overlay_arr[8] = {
    0, ((overlay >> 4) & 0x01 ? VFDCO_8D14S_OVERLAY_DP_LEFT : 0) | ((overlay >> 2) & 0x01 ? VFDCO_8D14S_OVERLAY_COL_LEFT : 0),
    0, (overlay >> 1) & 0x01 ? VFDCO_8D14S_OVERLAY_COL_CENTER : 0,
    0, ((overlay >> 3) & 0x01 ? VFDCO_8D14S_OVERLAY_DP_RIGHT : 0) | (overlay & 0x01 ? VFDCO_8D14S_OVERLAY_COL_RIGHT : 0),
    0, 0
  };
  
  for(uint8_t i = 0; i < 8; ++i) {
    vfdco_8d14s_write_char_with_overlay(i, text[i], overlay_arr[i]);
  }
}